parameters:
  - name: clusterName
    type: string
  - name: dnsDomain
    type: string
    default: "gerega.net"

resources:
  repositories:
    - repository: provisioning
      type: github
      endpoint: "Github"
      name: spyder007/provisioning-projects

variables:
  - group: unifi-api
  - group: auth-api-credentials

jobs:
- job: cluste_cycle
  displayName: Cycle Cluster
  timeoutInMinutes: 90
  pool:
    name: Provisioning
  steps:
    - checkout: self
      path: s/automation
    - checkout: provisioning
      path: s/provisioning
    - task: DownloadSecureFile@1
      name: secretvars
      inputs:
        secureFile: ubuntu-base-secrets.pkrvars.hcl
    - task: DownloadSecureFile@1
      name: authkeys
      inputs:
        secureFile: authorized_keys
    - pwsh: |     
        Install-Module powershell-yaml -Force

        $addPath = "C:\Program Files\OpenSSL-Win64\bin"
        $regexAddPath = [regex]::Escape($addPath)
        $arrPath = $env:Path -split ';' | Where-Object {$_ -notMatch "^$regexAddPath\\?"}
        $env:Path = ($arrPath + $addPath) -join ';'
        Write-Host "Import provisioning modules"
        Get-childItem "$(Build.SourcesDirectory)\provisioning\*.psm1" | % { Import-Module $_.FullName -Force }

        Write-Host "Copy authorized keys to files"
        if (-not (Test-Path "$(Build.SourcesDirectory)/provisioning/templates/ubuntu-quick/basic/files/")) {
          New-Item -ItemType Directory "$(Build.SourcesDirectory)/provisioning/templates/ubuntu-quick/basic/files/"
        }

        Copy-Item "$(authkeys.secureFilePath)" "$(Build.SourcesDirectory)/provisioning/templates/ubuntu-quick/basic/files/authorized_keys"

        Write-Host "Finding latest base image"
        $baseImage = Get-ChildItem \\cloud.gerega.net\Images\bases\ubuntu-* | Sort-Object -Property Name -Descending | Select-Object -first 1
        $imageFolder = Get-ChildItem $baseImage.FullName | Select-Object -first 1

        Write-Host "Using $($imageFolder.FullName) for Base Image"
        Set-Rke2Settings -nodePrefix "gk" -clusterStorage "\\cloud.gerega.net\rke-info" -secretsVariableFile "$(secretvars.secureFilePath)" -baseVmcxPath "$($imageFolder.FullName)" -baseVmName "$($imageFolder.Name)"

        Write-Host "Configure Unifi Client Settings"
        Set-AuthApiEnvironmentVariables -authUrl $(auth-url) -clientId $(auth-client-id) -clientSecret "$(auth-client-secret)" -userName $(auth-username) -password "$(auth-password)"
        Set-UnifiEnvironmentVariables -provisionUrl $(unifi-url) -provisionGroup $(unifi-provisioning-group)

        Write-Host "Cycle RKE Cluster"
        Push-Location "$(Build.SourcesDirectory)\provisioning"
        Cycle-Rke2ClusterNodes -clusterName "${{ parameters.clusterName }}" -dnsDomain "${{ parameters.dnsDomain }}" -OutputFolder "D:\Hyper-V\"

      displayName: Cycle Cluster Nodes